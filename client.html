<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />

    <title>NMS</title>

    <!--slick grid style sheets-->
    <link rel="stylesheet" href="client/slickgrid/slick.grid.css" type="text/css"/>
    <link rel="stylesheet" href="client/slickgrid/css/smoothness/jquery-ui-1.8.16.custom.css" type="text/css"/>
    <link rel="stylesheet" href="client/slickgrid/controls/slick.pager.css" type="text/css"/>
    <link rel="stylesheet" href="client/slickgrid/controls/slick.columnpicker.css" type="text/css"/>
    <!--slick grid core-->
    <script src="client/slickgrid/lib/jquery-1.7.min.js"></script>
    <script src="client/slickgrid/lib/jquery.event.drag-2.2.js"></script>
    <script src="client/slickgrid/slick.core.js"></script>
    <script src="client/slickgrid/slick.grid.js"></script>
    <script src="client/slickgrid/slick.dataview.js"></script>
    <script src="client/slickgrid/lib/firebugx.js"></script>
    <script src="client/slickgrid/lib/jquery-1.7.min.js"></script>
    <script src="client/slickgrid/lib/jquery-ui-1.8.16.custom.min.js"></script>
    <script src="client/slickgrid/lib/jquery.event.drag-2.2.js"></script>
    <script src="client/slickgrid/slick.core.js"></script>
    <script src="client/slickgrid/slick.formatters.js"></script>
    <script src="client/slickgrid/slick.editors.js"></script>
    <script src="client/slickgrid/plugins/slick.rowselectionmodel.js"></script>
    <script src="client/slickgrid/controls/slick.pager.js"></script>
    <script src="client/slickgrid/controls/slick.columnpicker.js"></script>
    <!--custom jquery -->
    <link rel="stylesheet"  type="text/css" media="screen" href="client/css/flat-8139-theme/jquery-ui-1.10.4.custom.min.css">
    <script type='text/javascript' src="client/js/jquery-1.10.2.min.js"></script>
    <script type='text/javascript' src="client/js/jquery-ui-1.10.4.custom.min.js"></script>
    <!--local terminal, dialogextend and jquery mouswheel plugin -->
    <script type='text/javascript' src="client/js/jquery.mousewheel.js"></script>
    <script type="text/javascript" src="client/js/jquery.dialogextend.min.js"></script>
    <script type='text/javascript' src="client/js/term.js"></script>
    <!--socket.io and bone.io for realtime shell server-->
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/bone.io/bone.io.js"></script>
    <!--client style -->
    <link rel="stylesheet" href="client/css/client.css">





</head>
<body >
<div id="new-term-window" title='terminal'  class="new-div-window" style='background-image: url("client/css/images/terminal-cc8139.svg");' ></div>
<div id="new-syslog-window" title='syslog'  class="new-div-window" style='background-image: url("client/css/images/syslog-cc8139.svg");' ></div>


</body>

  <script type='text/javascript'>
      socket = io.connect();
      bone.set('io.options', { socket: socket });

      var SHELL_CLIENT = {};
      var SYSLOG_CLIENT = [];
      var ShellIndex = 0;
      var SHELL_SERVER = bone.io('shell', {
          outbound: {
              routes: ['create', 'destroy', 'data']
          },
          inbound: {
              data: function (data, context) {
                  SHELL_CLIENT[data.shellname].write(data.data);
              }
          }
      });
      var syslogdata = [];
      var dataView = [];
      var columns = [

                { id: "date", name: "Date", field: "date", sortable: false },
                { id: "time", name: "Time", field: "time", sortable: false },
                { id: "facility", name: "Facility", field: "facility", sortable: false },
                { id: "severity", name: "Severity", field: "severity", sortable: false },
                { id: "host", name: "Host", field: "host", sortable: false },
                { id: "msg", name: "Message", field: "msg", width: 1200, sortable: false, selectable: true,}
              ];

      var options = {
          enableColumnReorder: false,
          editable: false,
          enableAddRow: false,
          enableCellNavigation: true,
          forceFitColumns: false
      };
      
      function debounce(func, wait, immediate) {
        var timeout;
        return function () {
            var context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                timeout = null;
                if (!immediate) {
                    func.apply(context, args);
                }
            }, wait);
            if (immediate && !timeout) func.apply(context, args);
        };
       };

       var smoother = debounce(function () { 
       for (var i = 0; i <= dataView.length; i++) {
                      if (dataView[i]) {
                          dataView[i].refresh();
                      }
                  }
       }, 10, false);

      var SYSLOG_SERVER = bone.io('syslog', {
          outbound: {
          },
          inbound: {
              data: function (data, context) {
                  syslogdata.unshift(data.data);
                   for (var i = 0; i <= dataView.length; i++) {
                      if (dataView[i] && !dataView[i]['SYSLOG']['PAUSED']) {
                            dataView[i]['SYSLOG']['DATA'].unshift(data.data);                          
                      }
                  }
                   smoother();
              }
          }
      });

</script>
  <script>

    $('#new-term-window').click(function () { TERMINAL_WINDOW(); });
    $('#new-syslog-window').click(function () { SYSLOG_WINDOW(); });
    var DivIndex = 0
    var APP = this;



    function TERMINAL_WINDOW(){
                          $('<div/>', {
                                        id: 'div-window-' + DivIndex,
                                        "height": '420px'
                                    })
                                    .appendTo("body")
                                    .dialog({
                                        "title": "terminal_" + DivIndex,
                                        "width": '750px',
                                        minHeight: 420,
                                        minWidth: 750,
                                        close: function( event, ui ) { $('#div-window-' + DivIndex).remove(); }
                                    })
                                    .dialogExtend({
                                        "closable": true,
                                        "minimizable": true,
                                        "collapsable": true,
                                        "dblclick" : "collapse",
                                        "titlebar": "transparent",
                                        "minimizeLocation": "left",
                                    });
                                    
                                    //Create Shell
                                    var shell_name = 'terminal_' + ShellIndex;
                                    ShellIndex++;

                                    //Clear terminal colors to use CSS
                                    Terminal.colors[256] = '';
                                    Terminal.colors[257] = '';

                                    //Create a Shell Client Terminal to connect to the Shell Server
                                    SHELL_CLIENT[shell_name] = new Terminal({
                                        cols: 100,
                                        rows: 25,
                                        screenKeys: true
                                    });

                                    //Attach Shell Client Terminal to Window body
                                    var element = document.getElementById('div-window-' + DivIndex);
                                    SHELL_CLIENT[shell_name].open(element, shell_name);

                                    //Send the  Shell Client Terminal data to the Shell Server
                                    SHELL_CLIENT[shell_name].on('data', function (data) {
                                        SHELL_SERVER.data({
                                            shellname: shell_name,
                                            data: data
                                        });

                                    });
                                    //Create Shell Client Terminal session on the Shell Server
                                    SHELL_SERVER.create({ shellname: shell_name, data: '' });

                                    DivIndex++;
    }

     function SYSLOG_WINDOW(args) {

     
                          $('<div/>', {
                                        id: 'div-window-' + DivIndex,
                                        "height": '420px'
                                    })
                                    .appendTo("body")
                                    .dialog({
                                        "title": '',
                                        "width": '750px',
                                        minHeight: 420,
                                        minWidth: 750,
                                        close: function( event, ui ) { $('#div-window-' + DivIndex).remove(); },
                                        resize: function(event,ui){  grid.resizeCanvas(); }
                                    })
                                    .dialogExtend({
                                        "closable": true,
                                        "minimizable": true,
                                        "collapsable": true,
                                        "dblclick" : "collapse",
                                        "titlebar": "transparent",
                                        "minimizeLocation": "left",
                                    })
                                    .data( "uiDialog" )._title = function(title) {title.html( this.options.title );};
                                    $("#div-window-" + DivIndex).dialog('option', 'title', '<span style="float:left;">Syslog filter for:<input style="border:0;background:#cc8139;color:#262626;z-index:2000;" type="text" id="txtSearch'+ DivIndex +'"><button title="Play/Pause" style="height:20px;width:32px;border:none;" id="PauseGrid' + DivIndex +'"/></span>');
                                    $('#txtSearch'+ DivIndex).click(function () { this.focus() });

                

                $(function() {
                    $("#PauseGrid" + DivIndex).button({
                        icons: {
                            primary: "ui-icon-pause"
                        }
                    })
                });

                var grid;
                var sortcol = "";
                var sortdir = 1;
                var searchString = "";

                dataView[DivIndex] = new Slick.Data.DataView({ inlineFilters: true });
                dataView[DivIndex]['SYSLOG'] = {};
                dataView[DivIndex]['SYSLOG']['DATA'] = [];
                dataView[DivIndex]['SYSLOG']['PAUSED'] = false;

                var dv = dataView[DivIndex];

                grid = new Slick.Grid("#div-window-" + DivIndex, dataView[DivIndex], columns, options);

                grid.setSelectionModel(new Slick.RowSelectionModel());


                // wire up the search textbox to apply the filter to the model
                $("#txtSearch" + DivIndex).keyup(function (e) {
                    Slick.GlobalEditorLock.cancelCurrentEdit();

                    // clear on Esc
                    if (e.which == 27) {
                        this.value = "";
                    }

                    searchString = this.value;
                    updateFilter();
                });

                function updateFilter() {
                    dv.setFilterArgs({
                        searchString: searchString
                    });
                    dv.refresh();
                }
                 function myFilter(item, args) {
                    var found = false;
                    if (args.searchString == "") {
                        return true;
                    }
                    if (item["msg"].indexOf(args.searchString) > -1) {
                        found = true;
                    }
                    if (item["host"].indexOf(args.searchString) > -1) {
                        found = true;
                    }
                    if (item["severity"].indexOf(args.searchString) > -1) {
                        found = true;
                    }
                    if (item["facility"].indexOf(args.searchString) > -1) {
                        found = true;
                    }
                    if (item["time"].indexOf(args.searchString) > -1) {
                        found = true;
                    }
                    if (item["date"].indexOf(args.searchString) > -1) {
                        found = true;
                    }
                    return found;
                }
                // wire up model events to drive the grid
                 dv.onRowCountChanged.subscribe(function (e, args) {
                    grid.updateRowCount();
                    grid.render();
                });
                dv.onRowsChanged.subscribe(function (e, args) {
                    grid.invalidateRows(args.rows);
                    grid.render();
                });

                    // initialize the model after all the events have been hooked up
                dv.beginUpdate();
                dv.setItems(dv['SYSLOG']['DATA']);
                dv.setFilterArgs({searchString: searchString});
                dv.setFilter(myFilter);
                dv.endUpdate();



               $( '#PauseGrid' + DivIndex).click(function() {
                    if(dv['SYSLOG']['PAUSED']){
                    $(".ui-button-icon-primary", this).toggleClass("ui-icon-pause ui-icon-play");
                           var counter = syslogdata.length - dv['SYSLOG']['DATA'].length -1;
                          while(syslogdata.length > dv['SYSLOG']['DATA'].length){

                          dv['SYSLOG']['DATA'].unshift(syslogdata[counter]);

                          counter--;

                          }
                          dv.refresh();
                    }else{
                    $(".ui-button-icon-primary", this).toggleClass("ui-icon-play ui-icon-pause");
                    }
                    dv['SYSLOG']['PAUSED']=!dv['SYSLOG']['PAUSED'];
			});



                DivIndex++;
     }


</script>

</html>